---
schemaType: Bundle
schemaVersion: 1.0.1
name: fermyon-wasm-hello
version: 0.1.0
description: ""
registry: localhost:5000
mixins:
  - arm
  - exec
  - terraform:
      clientVersion: 1.2.9
      workingDir: ./terraform
parameters:
  - name: location
    type: string
    default: EastUS
  - name: resource_group_name
    type: string
    default: porter-terraform
  - name: storage_account_name
    type: string
    default: porterstorage
  - name: storage_container_name
    type: string
    default: portertf
  - name: storage_rg
    type: string
    default: porter-storage
  - name: database-name
    type: string
    default: porter-terraform
credentials:
  - name: subscription_id
    env: AZURE_SUBSCRIPTION_ID
  - name: tenant_id
    env: AZURE_TENANT_ID
  - name: client_id
    env: AZURE_CLIENT_ID
  - name: client_secret
    env: AZURE_CLIENT_SECRET
outputs:
  - name: dns_domain
    type: string
    applyTo:
      - install
  - name: hippo_username
    type: string
    applyTo:
      - install
  - name: hippo_password
    type: string
    applyTo:
      - install
  - name: hippo_url
    type: string
    applyTo:
      - install
  - name: bindle_url
    type: string
    applyTo:
      - install
state:
  - name: tfstate
    path: terraform/terraform.tfstate
  - name: tfvars
    path: terraform/terraform.tfvars.json

install:
  - arm:
      description: Create an Azure Storage Account
      type: arm
      template: arm/storage.json
      name: ${ bundle.parameters.storage_account_name }
      resourceGroup: ${ bundle.parameters.storage_rg }
      parameters:
        location: ${ bundle.parameters.location }
        storageAccountName: ${ bundle.parameters.storage_account_name }
        storageContainerName: ${ bundle.parameters.storage_container_name }
      outputs:
        - name: storage_account_key
          key: storage_account_key
  - terraform:
      backendConfig: null
      key: ${ bundle.name }}.tfstate
      storage_account_name: ${ bundle.parameters.storage_account_name }
      container_name: ${ bundle.parameters.storage_container_name }
      access_key: ${ bundle.outputs.storage_account_key }
      outputs:
        - name: dns_domain
        - name: hippo_username
        - name: hippo_password
        - name: hippo_url
        - name: bindle_url
upgrade:
  - exec:
      description: World 2.0
      command: ./helpers.sh
      arguments:
        - upgrade
uninstall:
  - terraform:
      description: Uninstall
      backendConfig: null
      key: ${ bundle.name }}.tfstate
      storage_account_name: ${ bundle.parameters.storage_account_name }
      container_name: ${ bundle.parameters.storage_container_name }
      access_key: ${ bundle.outputs.storage_account_key }